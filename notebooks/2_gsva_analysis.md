Gene Set Variation Analysis
================
Jack Gisby
2022-04-28

-   [Load data and code](#load-data-and-code)
    -   [Load packages and custom
        functions](#load-packages-and-custom-functions)
    -   [Load RNA-seq data](#load-rna-seq-data)
    -   [Load SOMA protein data](#load-soma-protein-data)
    -   [Setup Gene Set Variation
        Analysis](#setup-gene-set-variation-analysis)
-   [Differential expression analyses of COVID-19
    status](#differential-expression-analyses-of-covid-19-status)
    -   [RNA-seq analysis using dream and
        GSVA](#rna-seq-analysis-using-dream-and-gsva)
    -   [Proteomic analysis using GSVA](#proteomic-analysis-using-gsva)
-   [Differential expression analyses of COVID-19 severity at time of
    sampling](#differential-expression-analyses-of-covid-19-severity-at-time-of-sampling)
    -   [RNA-seq analysis using GSVA](#rna-seq-analysis-using-gsva)
    -   [Proteomic analysis using
        GSVA](#proteomic-analysis-using-gsva-1)
-   [Session info](#session-info)

# Load data and code

## Load packages and custom functions

This chunk loads packages required for the notebook in addition to
custom functions in the `../R` directory. These include functions for
loading data, running differential expression and enrichment analyses
and making plots. The main functions and their arguments are described
by comments within these files.

``` r
# load relevant packages
library(data.table)
library(SummarizedExperiment)
library(lmerTest)
library(GSVA)
library(biomaRt)
library(edgeR)

# set up plotting settings
library(ggplot2)
library(ggpubr)

theme_set(theme_pubr(border = TRUE))
theme_update(text = element_text(size = 8))

# load custom functions from the R/ directory
source("../R/preprocessing.R")
source("../R/de.R")

set.seed(1)
```

## Load RNA-seq data

The raw RNA-seq counts are loaded, transformed into
`SummarizedExperiment` objects, and split into the “Wave 1” and “Wave 2”
cohorts. `SnowParam` is also initialised for the differential expression
analysis using the `variancePartition` package.

``` r
# get the raw RNA-seq counts
htseq_counts <- data.frame(fread("../data/htseq_counts.csv"))

mart <- useDataset("hsapiens_gene_ensembl", useMart("ensembl", host="uswest.ensembl.org"))

# get the wave 1 and wave 2 counts and their associated metadata
wave1_counts <- get_summarized_experiment(
  htseq_counts, 
  "../data/w1_metadata.csv", 
  mart = mart
)

wave2_counts <- get_summarized_experiment(
  htseq_counts, 
  "../data/w2_metadata.csv", 
  mart = mart
)
```

## Load SOMA protein data

The SOMA data is loaded into wide format (a matrix of samples x
proteins) and split into the “Wave 1” and “Wave 2” cohorts by the
`get_soma_data` function.

``` r
wave1_soma <- get_soma_data(
  soma_abundance = "../../data/20210819_soma_processed/soma_abundances.csv", 
  sample_meta = "../../scripts/20210713_salmon_counts_initial_look/w1_metadata.csv", 
  sample_technical_meta = "../../data/20210819_soma_processed/sample_meta.csv", 
  feature_meta = "../../data/20210819_soma_processed/feature_meta.csv",
  ret_wide = TRUE
)

# convert column names from sequence IDs to gene IDs
colnames(wave1_soma$soma_abundance) <- sapply(colnames(wave1_soma$soma_abundance), function(cname) {
  wave1_soma$feature_meta$gene_id[wave1_soma$feature_meta$converted_seq_ids == cname]
}) 

# remove duplicated genes
wave1_soma$soma_abundance <- wave1_soma$soma_abundance[, !duplicated(colnames(wave1_soma$soma_abundance))]
wave1_soma$feature_meta <- wave1_soma$feature_meta[!duplicated(wave1_soma$feature_meta$converted_seq_ids) ,]

wave2_soma <- get_soma_data(
  soma_abundance = "../data/soma_abundance.csv", 
  sample_meta = "../data/w2_metadata.csv", 
  sample_technical_meta = "../data/sample_technical_meta.csv", 
  feature_meta = "../data/feature_meta.csv",
  ret_wide = TRUE
)

# convert column names from sequence IDs to gene IDs
colnames(wave2_soma$soma_abundance) <- sapply(colnames(wave2_soma$soma_abundance), function(cname) {
  wave2_soma$feature_meta$gene_id[wave2_soma$feature_meta$converted_seq_ids == cname]
}) 

# remove duplicated genes
wave2_soma$soma_abundance <- wave2_soma$soma_abundance[, !duplicated(colnames(wave2_soma$soma_abundance))]
wave2_soma$feature_meta <- wave2_soma$feature_meta[!duplicated(wave2_soma$feature_meta$converted_seq_ids) ,]
```

## Setup Gene Set Variation Analysis

We use the MsigDB C2 gene sets to create a GeneSetCollection object for
GSVA.

The symbols file has been edited to include two additional gene sets.

``` r
# reads msigdb release 7.4 symbols, edited to include two additional modules
gsc.file <- scan("data/20210811_gsva/c2.cp.v7.4.symbols.edited.txt", what = "", sep="\n")
gsclist <- strsplit(gsc.file, "[[:space:]]+")
names(gsclist) <- sapply(gsclist, `[[`, 1)

gsclist <- lapply(gsclist, `[`, -1)
gsclist <- lapply(gsclist, `[`, -1)

uniqueList <- lapply(gsclist, unique)

makeSet <- function(geneIds, n) {GeneSet(geneIds, geneIdType=SymbolIdentifier(), setName=n)}
gsclist <- mapply(makeSet, uniqueList[], names(gsclist))

gsc <- GeneSetCollection(gsclist)
```

# Differential expression analyses of COVID-19 status

The differential expression analyses performed in this document are
essentially identical to the analyses performed in the
`1_differential_expression.Rmd` notebook, however here we analyse gene
sets rather than individual genes and proteins.

We also do not compare pre-infection and recovery samples using GSVA.

## RNA-seq analysis using dream and GSVA

In this section, we calculate the gene set x sample matrix for each
cohort and compare COVID-19 positive vs. negative samples for each
cohort using linear mixed models.

### Wave 1 transcriptomic COVID-19 infected vs. non-infected comparison

``` r
# apply normalisation to counts (returns edgeR DGE object)
wave1_case_control_se <- normalize_se(
  wave1_counts,
  normalisation_level = "logcpm",
  group = "case_control"
)

# remove duplicated genes
wave1_case_control_se <- wave1_case_control_se[!duplicated(rowData(wave1_case_control_se)$gene_id), ]
rownames(wave1_case_control_se) <- rowData(wave1_case_control_se)$gene_id

# calculate GSVA (gene set x samples matrix)
wave1_case_control_eset <- gsva(
  assay(wave1_case_control_se, 2), 
  gsc, 
  min.sz = 10, 
  max.sz = Inf, 
  parallel.sz = 8
)
```

    ## Setting parallel calculations through a MulticoreParam back-end
    ## with workers=8 and tasks=100.
    ## Estimating GSVA scores for 2170 gene sets.
    ## Estimating ECDFs with Gaussian kernels
    ## Estimating ECDFs in parallel on 8 cores
    ##   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  40%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  57%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  80%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================| 100%

``` r
# apply linear mixed models to gene sets
wave1_case_control_eset_models <- eset_de(
  se = wave1_case_control_se,
  eset = wave1_case_control_eset,
  formula_string = "set_expr ~ case_control + sex + ethnicity + calc_age + (1 | individual_id)"
)

# function to convert list of models to table of results
get_eset_results <- function(models, wave, data_type, comparison) {
    
    eset_de <- data.frame()
    
    if (comparison == "negative_vs_positive") {
        t <- "case_controlPOSITIVE"
        anova_col <- "case_control"
    } else {
        t <- "WHO_temp_severity.L"
        anova_col <- "WHO_temp_severity"
    }
    
    for (i in 1:length(models)) {
      set_anova <- anova(models[[i]])
      set_summ <- summary(models[[i]])
    
      eset_de <- rbind(eset_de, data.frame(
        term_id = names(models)[i],
        pval = set_anova$`Pr(>F)`[rownames(set_anova) == anova_col],
        beta = set_summ$coefficients[rownames(set_summ$coefficients) == t, colnames(set_summ$coefficients) == "Estimate"],
        se = set_summ$coefficients[rownames(set_summ$coefficients) == t, colnames(set_summ$coefficients) == "Std. Error"]
      ))
    }
    
    eset_de$log_p <- -log10(eset_de$pval)
    eset_de$adj_p <- p.adjust(eset_de$pval, method = "BH")
    
    write.csv(eset_de, paste0("../results/2_gsva_analysis/wave_", wave, "/", data_type, "_", comparison, ".csv"), row.names = FALSE)
    
    return(eset_de)
}

wave1_case_control_eset_de <- get_eset_results(wave1_case_control_eset_models, 1, "gene", "negative_vs_positive")
```

### Wave 2 transcriptomic COVID-19 infected vs. pre-infection comparison

``` r
# apply normalisation to counts (returns edgeR DGE object)
wave2_case_control_se <- normalize_se(
  wave2_counts[, wave2_counts$case_control != "RECOVERY"],
  normalisation_level = "logcpm",
  group = "case_control"
)

# remove duplicated genes
wave2_case_control_se <- wave2_case_control_se[!duplicated(rowData(wave2_case_control_se)$gene_id), ]
rownames(wave2_case_control_se) <- rowData(wave2_case_control_se)$gene_id

# calculate GSVA (gene set x samples matrix)
wave2_case_control_eset <- gsva(
  assay(wave2_case_control_se, 2), 
  gsc, 
  min.sz = 10, 
  max.sz = Inf, 
  parallel.sz = 8
)
```

    ## Setting parallel calculations through a MulticoreParam back-end
    ## with workers=8 and tasks=100.
    ## Estimating GSVA scores for 2165 gene sets.
    ## Estimating ECDFs with Gaussian kernels
    ## Estimating ECDFs in parallel on 8 cores
    ##   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  40%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  57%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  80%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================| 100%

``` r
# apply linear mixed models to gene sets
wave2_case_control_eset_models <- eset_de(
  se = wave2_case_control_se,
  eset = wave2_case_control_eset,
  formula_string = "set_expr ~ case_control + sex + ethnicity + calc_age + (1 | individual_id)"
)

wave2_case_control_eset_de <- get_eset_results(wave2_case_control_eset_models, 2, "gene", "negative_vs_positive")
```

## Proteomic analysis using GSVA

As for the transcriptomic data, we use GSVA to summarise the proteomics
data into sets of proteins, then use linear mixed models to associate
them with COVID-19 status.

### Wave 1 proteomic COVID-19 infected vs. non-infected comparison

``` r
# apply GSVA to protein matrix
wave1_case_control_pset <- gsva(t(wave1_soma$soma_abundance), gsc, min.sz = 10, max.sz = Inf, verbose = TRUE, parallel.sz = 8)
```

    ## Setting parallel calculations through a MulticoreParam back-end
    ## with workers=8 and tasks=100.
    ## Estimating GSVA scores for 1761 gene sets.
    ## Estimating ECDFs with Gaussian kernels
    ## Estimating ECDFs in parallel on 8 cores
    ##   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  40%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  57%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  80%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================| 100%

``` r
# apply linear mixed models to protein sets
wave1_case_control_pset_models <- pset_de(
  se = t(wave1_soma$soma_abundance),
  pset = wave1_case_control_pset,
  col_data = wave1_soma$sample_meta,
  formula_string = "set_expr ~ case_control + sex + ethnicity + calc_age + (1 | individual_id)"
)

wave1_case_control_pset_de <- get_eset_results(wave1_case_control_pset_models, 1, "protein", "negative_vs_positive")
```

### Wave 2 proteomic COVID-19 infected vs. non-infected comparison

``` r
# apply GSVA to protein matrix
wave2_case_control_pset <- gsva(t(wave2_soma$soma_abundance), gsc, min.sz = 10, max.sz = Inf, verbose = TRUE, parallel.sz = 8)
```

    ## Setting parallel calculations through a MulticoreParam back-end
    ## with workers=8 and tasks=100.
    ## Estimating GSVA scores for 1761 gene sets.
    ## Estimating ECDFs with Gaussian kernels
    ## Estimating ECDFs in parallel on 8 cores
    ##   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  40%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  57%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  80%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================| 100%

``` r
# apply linear mixed models to protein sets
wave2_case_control_pset_models <- pset_de(
  se = t(wave2_soma$soma_abundance),
  pset = wave2_case_control_pset,
  col_data = wave2_soma$sample_meta,
  formula_string = "set_expr ~ case_control + sex + ethnicity + calc_age + (1 | individual_id)"
)

wave1_case_control_pset_de <- get_eset_results(wave2_case_control_pset_models, 2, "protein", "negative_vs_positive")
```

# Differential expression analyses of COVID-19 severity at time of sampling

Like the analyses performed in the `1_differential_expression.Rmd`
notebook, we analyse COVID-19 positive samples by ordinal
contemporaneous severity. However, in this case we analyse gene and
proteins sets rather than individual genes and proteins.

## RNA-seq analysis using GSVA

### Wave 1 transcriptomic COVID-19 severity analysis

``` r
# convert contemporaneous severity to an ordered factor
wave1_counts$WHO_temp_severity <- ordered(wave1_counts$WHO_temp_severity, c("mild", "moderate", "severe", "critical"))

# get normalised expression matrix for COVID-19 positive samples
wave1_severity_se <- normalize_se(
  wave1_counts[, wave1_counts$case_control == "POSITIVE" & !is.na(wave1_counts$WHO_temp_severity)],
  normalisation_level = "logcpm",
  group = "WHO_temp_severity"
)

wave1_severity_se <- wave1_severity_se[!duplicated(rowData(wave1_severity_se)$gene_id), ]
rownames(wave1_severity_se) <- rowData(wave1_severity_se)$gene_id

# calculate GSVA to gene expression matrix
wave1_severity_eset <- gsva(assay(wave1_severity_se, 2), gsc, min.sz = 10, max.sz = Inf, verbose = TRUE, parallel.sz = 8)
```

    ## Setting parallel calculations through a MulticoreParam back-end
    ## with workers=8 and tasks=100.
    ## Estimating GSVA scores for 2191 gene sets.
    ## Estimating ECDFs with Gaussian kernels
    ## Estimating ECDFs in parallel on 8 cores
    ##   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  40%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  57%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  80%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================| 100%

``` r
# apply linear mixed models to gene sets
wave1_severity_eset_models <- eset_de(
  se = wave1_severity_se,
  eset = wave1_severity_eset,
  formula_string = "set_expr ~ WHO_temp_severity + sex + ethnicity + calc_age + (1 | individual_id)"
)

wave1_severity_eset_de <- get_eset_results(wave1_severity_eset_models, 1, "gene", "severity")
```

### Wave 2 transcriptomic COVID-19 severity analysis

``` r
# convert contemporaneous severity to an ordered factor
wave2_counts$WHO_temp_severity <- ordered(wave2_counts$WHO_temp_severity, c("mild", "moderate", "severe", "critical"))

# get normalised expression matrix for COVID-19 positive samples
wave2_severity_se <- normalize_se(
  wave2_counts[, wave2_counts$case_control == "POSITIVE" & !is.na(wave2_counts$WHO_temp_severity)],
  normalisation_level = "logcpm",
  group = "WHO_temp_severity"
)

wave2_severity_se <- wave2_severity_se[!duplicated(rowData(wave2_severity_se)$gene_id), ]
rownames(wave2_severity_se) <- rowData(wave2_severity_se)$gene_id

# calculate GSVA to gene expression matrix
wave2_severity_eset <- gsva(assay(wave2_severity_se, 2), gsc, min.sz = 10, max.sz = Inf, verbose = TRUE, parallel.sz = 8)
```

    ## Setting parallel calculations through a MulticoreParam back-end
    ## with workers=8 and tasks=100.
    ## Estimating GSVA scores for 2187 gene sets.
    ## Estimating ECDFs with Gaussian kernels
    ## Estimating ECDFs in parallel on 8 cores
    ##   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  40%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  57%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  80%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================| 100%

``` r
# apply linear mixed models to gene sets
wave2_severity_eset_models <- eset_de(
  se = wave2_severity_se,
  eset = wave2_severity_eset,
  formula_string = "set_expr ~ WHO_temp_severity + sex + ethnicity + calc_age + (1 | individual_id)"
)

wave2_severity_eset_de <- get_eset_results(wave2_severity_eset_models, 2, "gene", "severity")
```

## Proteomic analysis using GSVA

### Wave 1 proteomic COVID-19 severity analysis

``` r
# remove negative samples from protein matrix
pos_ids <- wave1_soma$sample_meta$sample_id[wave1_soma$sample_meta$case_control == "POSITIVE"]

wave1_soma_sev <- wave1_soma
wave1_soma_sev$soma_abundance <- wave1_soma_sev$soma_abundance[rownames(wave1_soma_sev$soma_abundance) %in% pos_ids ,]
wave1_soma_sev$sample_meta <- wave1_soma_sev$sample_meta[wave1_soma_sev$sample_meta$sample_id %in% pos_ids ,]

# convert contemporaneous severity to an ordered factor
wave1_soma_sev$sample_meta$WHO_temp_severity <- ordered(wave1_soma_sev$sample_meta$WHO_temp_severity, c("mild", "moderate", "severe", "critical"))

# calculate GSVA to protein matrix
wave1_severity_pset <- gsva(t(wave1_soma_sev$soma_abundance), gsc, min.sz = 10, max.sz = Inf, verbose = TRUE, parallel.sz = 8)
```

    ## Setting parallel calculations through a MulticoreParam back-end
    ## with workers=8 and tasks=100.
    ## Estimating GSVA scores for 1761 gene sets.
    ## Estimating ECDFs with Gaussian kernels
    ## Estimating ECDFs in parallel on 8 cores
    ##   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  40%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  57%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  80%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================| 100%

``` r
# apply linear mixed models to protein sets
wave1_severity_pset_models <- pset_de(
  se = t(wave1_soma_sev$soma_abundance),
  col_data = wave1_soma_sev$sample_meta,
  pset = wave1_severity_pset,
  formula_string = "set_expr ~ WHO_temp_severity + sex + ethnicity + calc_age + (1 | individual_id)"
)

wave1_severity_pset_de <- get_eset_results(wave1_severity_pset_models, 1, "protein", "severity")
```

### Wave 2 proteomic COVID-19 severity analysis

``` r
# remove negative samples from protein matrix
pos_ids <- wave2_soma$sample_meta$sample_id[wave2_soma$sample_meta$case_control == "POSITIVE"]

wave2_soma_sev <- wave2_soma
wave2_soma_sev$soma_abundance <- wave2_soma_sev$soma_abundance[rownames(wave2_soma_sev$soma_abundance) %in% pos_ids ,]
wave2_soma_sev$sample_meta <- wave2_soma_sev$sample_meta[wave2_soma_sev$sample_meta$sample_id %in% pos_ids ,]

# convert contemporaneous severity to an ordered factor
wave2_soma_sev$sample_meta$WHO_temp_severity <- ordered(wave2_soma_sev$sample_meta$WHO_temp_severity, c("mild", "moderate", "severe", "critical"))

# calculate GSVA to protein matrix
wave2_severity_pset <- gsva(t(wave2_soma_sev$soma_abundance), gsc, min.sz = 10, max.sz = Inf, verbose = TRUE, parallel.sz = 8)
```

    ## Setting parallel calculations through a MulticoreParam back-end
    ## with workers=8 and tasks=100.
    ## Estimating GSVA scores for 1761 gene sets.
    ## Estimating ECDFs with Gaussian kernels
    ## Estimating ECDFs in parallel on 8 cores
    ##   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  40%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  57%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  80%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================| 100%

``` r
# apply linear mixed models to protein sets
wave2_severity_pset_models <- pset_de(
  se = t(wave2_soma_sev$soma_abundance),
  col_data = wave2_soma_sev$sample_meta,
  pset = wave2_severity_pset,
  formula_string = "set_expr ~ WHO_temp_severity + sex + ethnicity + calc_age + (1 | individual_id)"
)

wave2_severity_pset_de <- get_eset_results(wave2_severity_pset_models, 2, "protein", "severity")
```

# Session info

Session information collected at the point this markdown document was
knit.

``` r
sessionInfo()
```

    ## R version 4.1.2 (2021-11-01)
    ## Platform: x86_64-w64-mingw32/x64 (64-bit)
    ## Running under: Windows 10 x64 (build 19044)
    ## 
    ## Matrix products: default
    ## 
    ## locale:
    ## [1] LC_COLLATE=English_United Kingdom.1252 
    ## [2] LC_CTYPE=English_United Kingdom.1252   
    ## [3] LC_MONETARY=English_United Kingdom.1252
    ## [4] LC_NUMERIC=C                           
    ## [5] LC_TIME=English_United Kingdom.1252    
    ## 
    ## attached base packages:
    ## [1] stats4    stats     graphics  grDevices utils     datasets  methods  
    ## [8] base     
    ## 
    ## other attached packages:
    ##  [1] ggpubr_0.4.0                ggplot2_3.3.5              
    ##  [3] edgeR_3.36.0                limma_3.50.1               
    ##  [5] biomaRt_2.50.3              GSVA_1.42.0                
    ##  [7] lmerTest_3.1-3              lme4_1.1-28                
    ##  [9] Matrix_1.3-4                SummarizedExperiment_1.24.0
    ## [11] Biobase_2.54.0              GenomicRanges_1.46.1       
    ## [13] GenomeInfoDb_1.30.1         IRanges_2.28.0             
    ## [15] S4Vectors_0.32.3            BiocGenerics_0.40.0        
    ## [17] MatrixGenerics_1.6.0        matrixStats_0.61.0         
    ## [19] data.table_1.14.2          
    ## 
    ## loaded via a namespace (and not attached):
    ##   [1] minqa_1.2.4                 colorspace_2.0-2           
    ##   [3] ggsignif_0.6.3              ellipsis_0.3.2             
    ##   [5] XVector_0.34.0              rstudioapi_0.13            
    ##   [7] bit64_4.0.5                 AnnotationDbi_1.56.2       
    ##   [9] fansi_1.0.2                 xml2_1.3.3                 
    ##  [11] splines_4.1.2               sparseMatrixStats_1.6.0    
    ##  [13] cachem_1.0.6                knitr_1.37                 
    ##  [15] nloptr_2.0.0                broom_0.7.12               
    ##  [17] annotate_1.72.0             dbplyr_2.1.1               
    ##  [19] png_0.1-7                   graph_1.72.0               
    ##  [21] HDF5Array_1.22.1            compiler_4.1.2             
    ##  [23] httr_1.4.2                  backports_1.4.1            
    ##  [25] assertthat_0.2.1            fastmap_1.1.0              
    ##  [27] cli_3.1.1                   BiocSingular_1.10.0        
    ##  [29] htmltools_0.5.2             prettyunits_1.1.1          
    ##  [31] tools_4.1.2                 rsvd_1.0.5                 
    ##  [33] gtable_0.3.0                glue_1.6.1                 
    ##  [35] GenomeInfoDbData_1.2.7      dplyr_1.0.8                
    ##  [37] rappdirs_0.3.3              Rcpp_1.0.8                 
    ##  [39] carData_3.0-5               vctrs_0.3.8                
    ##  [41] Biostrings_2.62.0           rhdf5filters_1.6.0         
    ##  [43] nlme_3.1-153                DelayedMatrixStats_1.16.0  
    ##  [45] xfun_0.29                   stringr_1.4.0              
    ##  [47] beachmat_2.10.0             lifecycle_1.0.1            
    ##  [49] irlba_2.3.5                 rstatix_0.7.0              
    ##  [51] XML_3.99-0.8                zlibbioc_1.40.0            
    ##  [53] MASS_7.3-54                 scales_1.1.1               
    ##  [55] hms_1.1.1                   parallel_4.1.2             
    ##  [57] rhdf5_2.38.0                SingleCellExperiment_1.16.0
    ##  [59] yaml_2.2.2                  curl_4.3.2                 
    ##  [61] memoise_2.0.1               stringi_1.7.6              
    ##  [63] RSQLite_2.2.10              ScaledMatrix_1.2.0         
    ##  [65] filelock_1.0.2              boot_1.3-28                
    ##  [67] BiocParallel_1.28.3         rlang_1.0.1                
    ##  [69] pkgconfig_2.0.3             bitops_1.0-7               
    ##  [71] evaluate_0.15               lattice_0.20-45            
    ##  [73] purrr_0.3.4                 Rhdf5lib_1.16.0            
    ##  [75] bit_4.0.4                   tidyselect_1.1.1           
    ##  [77] GSEABase_1.56.0             magrittr_2.0.2             
    ##  [79] R6_2.5.1                    generics_0.1.2             
    ##  [81] DelayedArray_0.20.0         DBI_1.1.2                  
    ##  [83] pillar_1.7.0                withr_2.4.3                
    ##  [85] abind_1.4-5                 KEGGREST_1.34.0            
    ##  [87] RCurl_1.98-1.6              tibble_3.1.6               
    ##  [89] car_3.0-12                  crayon_1.5.0               
    ##  [91] utf8_1.2.2                  BiocFileCache_2.2.1        
    ##  [93] rmarkdown_2.11              progress_1.2.2             
    ##  [95] locfit_1.5-9.4              grid_4.1.2                 
    ##  [97] blob_1.2.2                  digest_0.6.29              
    ##  [99] xtable_1.8-4                tidyr_1.2.0                
    ## [101] numDeriv_2016.8-1.1         munsell_0.5.0
